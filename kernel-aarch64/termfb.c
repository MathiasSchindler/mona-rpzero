#include "termfb.h"

#include "fb.h"

#define TERMFB_FONT_W 6u
#define TERMFB_FONT_H 8u

typedef struct glyph_def {
    char ch;
    uint8_t rows[7]; /* 5-bit rows (MSB is left-most pixel) */
} glyph_def_t;

static const glyph_def_t g_glyphs[] = {
    { ' ', { 0x00,0x00,0x00,0x00,0x00,0x00,0x00 } },

    /* Punctuation */
    { '!', { 0x04,0x04,0x04,0x04,0x04,0x00,0x04 } },
    { '"',{ 0x0A,0x0A,0x00,0x00,0x00,0x00,0x00 } },
    { '#', { 0x0A,0x0A,0x1F,0x0A,0x1F,0x0A,0x0A } },
    { '%', { 0x19,0x19,0x02,0x04,0x08,0x13,0x13 } },
    { '&', { 0x0C,0x12,0x14,0x08,0x15,0x12,0x0D } },
    { '\'',{ 0x04,0x04,0x02,0x00,0x00,0x00,0x00 } },
    { '(', { 0x02,0x04,0x08,0x08,0x08,0x04,0x02 } },
    { ')', { 0x08,0x04,0x02,0x02,0x02,0x04,0x08 } },
    { '*', { 0x00,0x0A,0x04,0x1F,0x04,0x0A,0x00 } },
    { '+', { 0x00,0x04,0x04,0x1F,0x04,0x04,0x00 } },
    { ',', { 0x00,0x00,0x00,0x00,0x06,0x06,0x04 } },
    { '-', { 0x00,0x00,0x00,0x1F,0x00,0x00,0x00 } },
    { '.', { 0x00,0x00,0x00,0x00,0x00,0x06,0x06 } },
    { '/', { 0x01,0x02,0x04,0x08,0x10,0x00,0x00 } },
    { ':', { 0x00,0x06,0x06,0x00,0x06,0x06,0x00 } },
    { ';', { 0x00,0x06,0x06,0x00,0x06,0x06,0x04 } },
    { '<', { 0x02,0x04,0x08,0x10,0x08,0x04,0x02 } },
    { '=', { 0x00,0x00,0x1F,0x00,0x1F,0x00,0x00 } },
    { '>', { 0x08,0x04,0x02,0x01,0x02,0x04,0x08 } },
    { '?', { 0x0E,0x11,0x01,0x02,0x04,0x00,0x04 } },
    { '[', { 0x1E,0x10,0x10,0x10,0x10,0x10,0x1E } },
    { '\\',{ 0x10,0x08,0x04,0x02,0x01,0x00,0x00 } },
    { ']', { 0x1E,0x02,0x02,0x02,0x02,0x02,0x1E } },
    { '_', { 0x00,0x00,0x00,0x00,0x00,0x00,0x1F } },
    { '|', { 0x04,0x04,0x04,0x04,0x04,0x04,0x04 } },

    /* Digits */
    { '0', { 0x0E,0x11,0x13,0x15,0x19,0x11,0x0E } },
    { '1', { 0x04,0x0C,0x04,0x04,0x04,0x04,0x0E } },
    { '2', { 0x0E,0x11,0x01,0x02,0x04,0x08,0x1F } },
    { '3', { 0x1F,0x02,0x04,0x02,0x01,0x11,0x0E } },
    { '4', { 0x02,0x06,0x0A,0x12,0x1F,0x02,0x02 } },
    { '5', { 0x1F,0x10,0x1E,0x01,0x01,0x11,0x0E } },
    { '6', { 0x06,0x08,0x10,0x1E,0x11,0x11,0x0E } },
    { '7', { 0x1F,0x01,0x02,0x04,0x08,0x08,0x08 } },
    { '8', { 0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E } },
    { '9', { 0x0E,0x11,0x11,0x0F,0x01,0x02,0x0C } },

    /* Uppercase */
    { 'A', { 0x0E,0x11,0x11,0x1F,0x11,0x11,0x11 } },
    { 'B', { 0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E } },
    { 'C', { 0x0E,0x11,0x10,0x10,0x10,0x11,0x0E } },
    { 'D', { 0x1C,0x12,0x11,0x11,0x11,0x12,0x1C } },
    { 'E', { 0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F } },
    { 'F', { 0x1F,0x10,0x10,0x1E,0x10,0x10,0x10 } },
    { 'G', { 0x0E,0x11,0x10,0x17,0x11,0x11,0x0F } },
    { 'H', { 0x11,0x11,0x11,0x1F,0x11,0x11,0x11 } },
    { 'I', { 0x0E,0x04,0x04,0x04,0x04,0x04,0x0E } },
    { 'J', { 0x07,0x02,0x02,0x02,0x02,0x12,0x0C } },
    { 'K', { 0x11,0x12,0x14,0x18,0x14,0x12,0x11 } },
    { 'L', { 0x10,0x10,0x10,0x10,0x10,0x10,0x1F } },
    { 'M', { 0x11,0x1B,0x15,0x15,0x11,0x11,0x11 } },
    { 'N', { 0x11,0x19,0x15,0x13,0x11,0x11,0x11 } },
    { 'O', { 0x0E,0x11,0x11,0x11,0x11,0x11,0x0E } },
    { 'P', { 0x1E,0x11,0x11,0x1E,0x10,0x10,0x10 } },
    { 'Q', { 0x0E,0x11,0x11,0x11,0x15,0x12,0x0D } },
    { 'R', { 0x1E,0x11,0x11,0x1E,0x14,0x12,0x11 } },
    { 'S', { 0x0E,0x11,0x10,0x0E,0x01,0x11,0x0E } },
    { 'T', { 0x1F,0x04,0x04,0x04,0x04,0x04,0x04 } },
    { 'U', { 0x11,0x11,0x11,0x11,0x11,0x11,0x0E } },
    { 'V', { 0x11,0x11,0x11,0x11,0x11,0x0A,0x04 } },
    { 'W', { 0x11,0x11,0x11,0x15,0x15,0x15,0x0A } },
    { 'X', { 0x11,0x11,0x0A,0x04,0x0A,0x11,0x11 } },
    { 'Y', { 0x11,0x11,0x0A,0x04,0x04,0x04,0x04 } },
    { 'Z', { 0x1F,0x01,0x02,0x04,0x08,0x10,0x1F } },

    /* Lowercase */
    { 'a', { 0x00,0x00,0x0E,0x01,0x0F,0x11,0x0F } },
    { 'b', { 0x10,0x10,0x1E,0x11,0x11,0x11,0x1E } },
    { 'c', { 0x00,0x00,0x0E,0x11,0x10,0x11,0x0E } },
    { 'd', { 0x01,0x01,0x0F,0x11,0x11,0x11,0x0F } },
    { 'e', { 0x00,0x00,0x0E,0x11,0x1F,0x10,0x0E } },
    { 'f', { 0x06,0x08,0x1E,0x08,0x08,0x08,0x08 } },
    { 'g', { 0x00,0x0F,0x11,0x11,0x0F,0x01,0x0E } },
    { 'h', { 0x10,0x10,0x1E,0x11,0x11,0x11,0x11 } },
    { 'i', { 0x04,0x00,0x0C,0x04,0x04,0x04,0x0E } },
    { 'j', { 0x02,0x00,0x06,0x02,0x02,0x12,0x0C } },
    { 'k', { 0x10,0x10,0x11,0x12,0x1C,0x12,0x11 } },
    { 'l', { 0x0C,0x04,0x04,0x04,0x04,0x04,0x0E } },
    { 'm', { 0x00,0x00,0x1A,0x15,0x15,0x11,0x11 } },
    { 'n', { 0x00,0x00,0x1E,0x11,0x11,0x11,0x11 } },
    { 'o', { 0x00,0x00,0x0E,0x11,0x11,0x11,0x0E } },
    { 'p', { 0x00,0x00,0x1E,0x11,0x11,0x1E,0x10 } },
    { 'q', { 0x00,0x00,0x0F,0x11,0x11,0x0F,0x01 } },
    { 'r', { 0x00,0x00,0x16,0x19,0x10,0x10,0x10 } },
    { 's', { 0x00,0x00,0x0F,0x10,0x0E,0x01,0x1E } },
    { 't', { 0x08,0x08,0x1E,0x08,0x08,0x09,0x06 } },
    { 'u', { 0x00,0x00,0x11,0x11,0x11,0x11,0x0F } },
    { 'v', { 0x00,0x00,0x11,0x11,0x11,0x0A,0x04 } },
    { 'w', { 0x00,0x00,0x11,0x11,0x15,0x15,0x0A } },
    { 'x', { 0x00,0x00,0x11,0x0A,0x04,0x0A,0x11 } },
    { 'y', { 0x00,0x00,0x11,0x11,0x0F,0x01,0x0E } },
    { 'z', { 0x00,0x00,0x1F,0x02,0x04,0x08,0x1F } },
};

static const uint8_t g_glyph_unknown[7] = { 0x1F,0x11,0x15,0x11,0x15,0x11,0x1F };

static const fb_info_t *g_info;
static uint32_t g_cols;
static uint32_t g_rows;
static uint32_t g_cur_x;
static uint32_t g_cur_y;
static uint32_t g_fg;
static uint32_t g_bg;

static const uint8_t *termfb_glyph_for(char c) {
    uint32_t n = (uint32_t)(sizeof(g_glyphs) / sizeof(g_glyphs[0]));
    for (uint32_t i = 0; i < n; i++) {
        if (g_glyphs[i].ch == c) {
            return g_glyphs[i].rows;
        }
    }
    return g_glyph_unknown;
}

static inline volatile uint32_t *termfb_row_ptr(uint32_t y) {
    return (volatile uint32_t *)((uintptr_t)g_info->virt + (uintptr_t)y * (uintptr_t)g_info->pitch);
}

static void termfb_clear_pixels(void) {
    if (!g_info || !g_info->virt) return;
    if (g_info->bpp != 32) return;

    for (uint32_t y = 0; y < g_info->height; y++) {
        volatile uint32_t *row = termfb_row_ptr(y);
        for (uint32_t x = 0; x < g_info->width; x++) {
            row[x] = g_bg;
        }
    }
}

static void termfb_scroll_one(void) {
    if (!g_info || !g_info->virt) return;
    if (g_info->bpp != 32) return;

    uint32_t rows_to_move = g_info->height - TERMFB_FONT_H;
    uint32_t words_per_row = g_info->pitch / 4u;

    for (uint32_t y = 0; y < rows_to_move; y++) {
        volatile uint32_t *dst = termfb_row_ptr(y);
        volatile uint32_t *src = termfb_row_ptr(y + TERMFB_FONT_H);
        for (uint32_t x = 0; x < words_per_row; x++) {
            dst[x] = src[x];
        }
    }

    /* Clear last character row (TERMFB_FONT_H pixel rows). */
    for (uint32_t y = rows_to_move; y < g_info->height; y++) {
        volatile uint32_t *row = termfb_row_ptr(y);
        for (uint32_t x = 0; x < g_info->width; x++) {
            row[x] = g_bg;
        }
    }
}

static void termfb_draw_char_cell(uint32_t cell_x, uint32_t cell_y, char c) {
    if (!g_info || !g_info->virt) return;
    if (g_info->bpp != 32) return;

    uint32_t px0 = cell_x * TERMFB_FONT_W;
    uint32_t py0 = cell_y * TERMFB_FONT_H;

    if (px0 + TERMFB_FONT_W > g_info->width) return;
    if (py0 + TERMFB_FONT_H > g_info->height) return;

    const uint8_t *rows = termfb_glyph_for(c);

    for (uint32_t ry = 0; ry < 7u; ry++) {
        uint8_t bits = rows[ry] & 0x1Fu;
        volatile uint32_t *row = termfb_row_ptr(py0 + ry);

        for (uint32_t rx = 0; rx < 5u; rx++) {
            uint32_t mask = 1u << (4u - rx);
            row[px0 + rx] = (bits & mask) ? g_fg : g_bg;
        }

        /* 1px spacing column */
        row[px0 + 5u] = g_bg;
    }

    /* Bottom spacing row */
    volatile uint32_t *bottom = termfb_row_ptr(py0 + 7u);
    for (uint32_t rx = 0; rx < TERMFB_FONT_W; rx++) {
        bottom[px0 + rx] = g_bg;
    }
}

int termfb_init(uint32_t fg_xrgb8888, uint32_t bg_xrgb8888) {
    g_info = fb_get_info();
    if (!g_info || !g_info->virt) return -1;
    if (g_info->bpp != 32) return -1;

    g_cols = g_info->width / TERMFB_FONT_W;
    g_rows = g_info->height / TERMFB_FONT_H;
    if (g_cols == 0 || g_rows == 0) return -1;

    g_fg = fg_xrgb8888;
    g_bg = bg_xrgb8888;

    g_cur_x = 0;
    g_cur_y = 0;

    termfb_clear_pixels();
    return 0;
}

void termfb_set_colors(uint32_t fg_xrgb8888, uint32_t bg_xrgb8888) {
    g_fg = fg_xrgb8888;
    g_bg = bg_xrgb8888;
}

void termfb_clear(void) {
    g_cur_x = 0;
    g_cur_y = 0;
    termfb_clear_pixels();
}

void termfb_putc(char c) {
    if (!g_info || !g_info->virt) return;

    if (c == '\r') {
        g_cur_x = 0;
        return;
    }

    if (c == '\n') {
        g_cur_x = 0;
        g_cur_y++;
        if (g_cur_y >= g_rows) {
            termfb_scroll_one();
            g_cur_y = g_rows - 1u;
        }
        return;
    }

    if (c == '\t') {
        uint32_t next = (g_cur_x + 4u) & ~3u;
        while (g_cur_x < next) {
            termfb_putc(' ');
        }
        return;
    }

    if (c == '\b') {
        if (g_cur_x > 0) {
            g_cur_x--;
        } else if (g_cur_y > 0) {
            g_cur_y--;
            g_cur_x = g_cols ? (g_cols - 1u) : 0;
        }
        termfb_draw_char_cell(g_cur_x, g_cur_y, ' ');
        return;
    }

    termfb_draw_char_cell(g_cur_x, g_cur_y, c);
    g_cur_x++;
    if (g_cur_x >= g_cols) {
        g_cur_x = 0;
        g_cur_y++;
        if (g_cur_y >= g_rows) {
            termfb_scroll_one();
            g_cur_y = g_rows - 1u;
        }
    }
}

void termfb_write(const char *s) {
    if (!s) return;
    while (*s) {
        termfb_putc(*s++);
    }
}

void termfb_write_hex_u64(uint64_t v) {
    static const char hex[] = "0123456789abcdef";

    termfb_write("0x");

    for (int i = 15; i >= 0; i--) {
        uint8_t nib = (uint8_t)((v >> ((uint64_t)i * 4ull)) & 0xFull);
        termfb_putc(hex[nib]);
    }
}
